---
title: "990 EFILER Data Catalog"
format: html
editor: visual
execute: 
  echo: false
  warning: false
---

```{r}
#| echo: false

library( dplyr )
library( knitr )
library( kableExtra )
library( stringr )

# GH.RAW <- "https://raw.githubusercontent.com/UrbanInstitute/nccs/main/catalogs/"
# d <- read.csv( paste0( GH.RAW, "AWS-NCCS-EFILE.csv" ) )

d <- read.csv( "AWS-NCCS-EFILE.csv" )
```

```{r}
#| echo: false
############
############   EFILE
############


get_efile_paths <- function( paths ) {
  expr <- "csv$"
  matches <- grep( expr, paths, value=T )
  return( matches )
}


get_efile_year <- function( paths ) {
  yyyy <- stringr::str_extract( paths, "-[0-9]{4}\\.csv" )
  yyyy <- gsub( "-", "", yyyy )
  yyyy <- gsub( "\\.csv", "", yyyy )
  return( yyyy )
}


# x <- "parsed/F9-P00-T00-HEADER-2009.csv"

get_efile_names <- function( x ) {
  x <- gsub( "parsed/", "", x )
  x <- gsub( "-[0-9]{4}.csv", "", x )
  return(x)
}

get_rdb_cardinality <- function( paths ) {
  ttt  <- stringr::str_extract( paths, "-T[0-9]{2}-" )
  ttt <- gsub(  "-", "", ttt )
  ttt <- gsub( "^T", "", ttt )
  card <- ifelse( ttt == "00", "1:1", "1:M" )
}


make_urls <- function( paths ) {
  base <- "https://nccs-efile.s3.us-east-1.amazonaws.com/"
  urls <- paste0( base, paths )
  return( urls )
}


make_buttons <- function( urls ) {
  buttons <- 
    paste0( "<a href=", urls, " class='button'> DOWNLOAD </a>" )
  return( buttons ) 
}

make_buttons_2 <- function( urls ) {
  buttons <- 
    paste0( 
      "<a href=",
      urls,
      " class='button2'> PROFILE </a>" )
  return( buttons ) 
}
```


<br>

<hr>

<br>

Files are organized as follows:

**FF-PPP-TTT-NAME**

- FF
  - F9 = Form 990
  - SA = Schedule A
  - SB = Schedule B, etc
- PPP
  - P01 = Part I
  - P02 = Part II
  - P03 = Part III, etc
  - P99 = field outside of a part on the form
- TTT
  - T00 = all one-to-one tables in current section 
  - T01, T02, etc = all one-to-many tables in a section 

Files that end in EZ represent tables that only appear on Form 990EZ. 

All other EFILE tables have PZ form scope, meaning they include data from both full 990 and 990EZ filers.


<br>

<hr>

<br>


```{r}
#| echo: false
#| output: asis
 
paths <- get_efile_paths( paths=d$Key )
urls  <- make_urls( paths )

BUTTONS  <- make_buttons( urls )
BUTTONS2 <- make_buttons_2( urls )
FNAME    <- get_efile_names( paths )
CARD     <- get_rdb_cardinality( paths )
YEAR     <- get_efile_year( paths )

catalog <- 
  data.frame( BUTTONS, BUTTONS2,
              YEAR=YEAR, NAME=FNAME, 
              RDB=CARD )
```

```{r}
#| echo: false
#| output: asis
#| 
fnames <- unique( FNAME )

for( i in fnames )
{
  cat( paste0( "#### ", i, " \n\n" ) )
  
  k <- 
  dplyr::filter( catalog, FNAME == i ) %>%
  knitr::kable( escape=FALSE,
                col.names =  
                  
                  c(  "",  "",  "Year",
                      "Table Name", 
                      "Cardinality"    ) ) %>%
    
  kableExtra::kable_styling()
  
  cat( k )
  cat( "\n\n"  )
}


```


```{=html}
<style>


h1.title {
 font-size: 60px;
 color: #0a4c6a;
}


h4, .h4 {
    font-size: 40px;
    color: #1696d2;
    margin-top: 50px;
    margin-bottom: 30px;
}



.button {
  background-color: white;
  color:  #12719e;
  border: 2px solid  #12719e;   /* #008CBA; */
  padding: 5px 10px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 14px;
  border-radius: 12px;
  width: 150px;
}
 
.button {
  transition-duration: 0.4s;
}

.button:hover {
  background-color: #1696d2; 
  color: white;
  border: 2px solid #12719e;
}


.button2 {
  background-color: white;
  color: #12719e;
  border: 2px solid #9d9d9d;   /* #008CBA; */
  padding: 5px 10px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 14px;
  border-radius: 12px;
  width: 150px;
}

.button2 {
  transition-duration: 0.4s;
}

.button2:hover {
  background-color: #fff2cf; 
  color: #1696d2;
  font-weight: bold;
  border: 2px solid #1696d2;
}


.center {text-align: center;}

table td {
  vertical-align: middle;
}

blockquote {
    border-left: 4px solid #1696d2;
    margin-left: 10px;
    margin-inline-start: 0px;
    margin-inline-end: 0px;
    padding: 15px;
}

.button3 {
  background-color: #0a4c6a;
  color: white;
  border: 2px solid #0a4c6a;   
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  border-radius: 4px;
  width: 100px;
}
</style>
```
